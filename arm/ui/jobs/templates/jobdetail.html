{% extends "base.html" %}
{% block title %}Job details{% endblock %}

{% block nav %}{{ super() }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/template_pages.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/job_details.css') }}">
{% set poster_src = jobs.poster_url if jobs.poster_url else url_for('static', filename='img/none.png') %}
{% set poster_alt = 'Poster image' if jobs.poster_url else 'Poster not found' %}
<div class="container job-detail-page template-page">
    <div class="row">
        <div class="col-12">
            <div class="card job-hero shadow-lg mb-4">
                {% if jobs.background %}
                    <div class="job-hero__backdrop" style="background-image: url('{{ jobs.background }}');"></div>
                {% endif %}
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-lg-4 text-center job-hero__poster">
                            <figure class="mb-0">
                                <a id="posterClick" href="#">
                                    <img src="{{ poster_src }}" alt="{{ poster_alt }}" class="img-fluid">
                                </a>
                                <figcaption class="mt-2">Click poster to toggle plot</figcaption>
                            </figure>
                            {% if jobs.video_type != "Music" %}
                                <div class="btn-group mt-3 job-actions" role="group">
                                    <a href="titlesearch?job_id={{ jobs.job_id }}" class="btn btn-outline-light btn-sm">Title Search</a>
                                    <a href="customTitle?job_id={{ jobs.job_id }}" class="btn btn-outline-light btn-sm">Custom Title</a>
                                    <button id="plot" class="btn btn-outline-light btn-sm" type="button">Plot</button>
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-lg-8">
                            <div class="d-flex flex-wrap align-items-start justify-content-between">
                                <div>
                                    <h2 class="job-title mb-1">{{ jobs.title }}{% if jobs.year %} <span class="text-light-50">({{ jobs.year }})</span>{% endif %}</h2>
                                    <div class="job-meta">
                                        <span class="mr-3"><strong>{{ jobs.video_type.capitalize() }}</strong></span>
                                        {% if jobs.job_length %}<span class="mr-3">Length: {{ jobs.job_length }}</span>{% endif %}
                                        {% if jobs.disc %}<span class="mr-3">Disc: {{ jobs.disc }}</span>{% endif %}
                                    </div>
                                </div>
                                <div class="ratings d-flex flex-wrap justify-content-end">
                                    {% if s and 'Ratings' in s %}
                                        {% for ratings in s['Ratings'] %}
                                            <span class="rating-pill {{ ratings['Source']|replace(' ', '-')|lower }}{{ '-rotten' if ratings['Source'] == 'Rotten Tomatoes' and ratings['Value']|replace('%','')|int < 60 else '' }}">
                                                {{ ratings['Value'].split('/')[0] if '/' in ratings['Value'] else ratings['Value'] }}
                                            </span>
                                        {% endfor %}
                                    {% endif %}
                                </div>
                            </div>
                            <div class="job-summary-badges mt-3">
                                <span class="badge badge-info">Status: {{ jobs.status }}</span>
                                <span class="badge badge-secondary">Type: {{ jobs.video_type }}</span>
                                {% if jobs.disctype %}<span class="badge badge-dark">Disc Type: {{ jobs.disctype }}</span>{% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="plotInfo" class="alert alert-info text-center" style="display: none;" role="alert">
                <h4 class="alert-heading">Plot for {{ jobs.title }}</h4>
                <hr>
                <p class="mb-0">{{ jobs.plot }}</p>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card detail-card h-100">
                <div class="card-header">Job Summary</div>
                <div class="card-body p-0">
                    <div class="detail-row"><span class="detail-label">Job ID</span><span class="detail-value">{{ jobs.job_id }}</span></div>
                    <div class="detail-row"><span class="detail-label">ARM Version</span><span class="detail-value">{{ jobs.arm_version }}</span></div>
                    <div class="detail-row"><span class="detail-label">CRC ID</span><span class="detail-value">{{ jobs.crc_id }}</span></div>
                    <div class="detail-row"><span class="detail-label">Logfile</span><span class="detail-value"><a href="logs?logfile={{ jobs.logfile }}&mode=full">{{ jobs.logfile }}</a></span></div>
                    <div class="detail-row"><span class="detail-label">Start Time</span><span class="detail-value">{{ jobs.start_time }}</span></div>
                    <div class="detail-row"><span class="detail-label">Stop Time</span><span class="detail-value">{{ jobs.stop_time }}</span></div>
                    <div class="detail-row"><span class="detail-label">Job Length</span><span class="detail-value">{{ jobs.job_length }}</span></div>
                    <div class="detail-row"><span class="detail-label">Disc</span><span class="detail-value">{{ jobs.disc }}</span></div>
                    <div class="detail-row"><span class="detail-label">Errors</span><span class="detail-value">{{ jobs.errors }}</span></div>
                    <div class="detail-row"><span class="detail-label">Has Nice Title</span><span class="detail-value">{{ jobs.hasnicetitle }}</span></div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card detail-card h-100">
                <div class="card-header">Metadata</div>
                <div class="card-body p-0">
                    <div class="detail-row"><span class="detail-label">Title</span><span class="detail-value">{{ jobs.title }}</span></div>
                    <div class="detail-row"><span class="detail-label">Title (Auto)</span><span class="detail-value">{{ jobs.title_auto }}</span></div>
                    <div class="detail-row"><span class="detail-label">Title (Manual)</span><span class="detail-value">{{ jobs.title_manual }}</span></div>
                    <div class="detail-row"><span class="detail-label">Year</span><span class="detail-value">{{ jobs.year }}</span></div>
                    <div class="detail-row"><span class="detail-label">Year (Auto)</span><span class="detail-value">{{ jobs.year_auto }}</span></div>
                    <div class="detail-row"><span class="detail-label">Year (Manual)</span><span class="detail-value">{{ jobs.year_manual }}</span></div>
                    <div class="detail-row"><span class="detail-label">Video Type</span><span class="detail-value">{{ jobs.video_type }}</span></div>
                    <div class="detail-row"><span class="detail-label">Video Type (Auto)</span><span class="detail-value">{{ jobs.video_type_auto }}</span></div>
                    <div class="detail-row"><span class="detail-label">Video Type (Manual)</span><span class="detail-value">{{ jobs.video_type_manual }}</span></div>
                    <div class="detail-row"><span class="detail-label">IMDB ID</span><span class="detail-value">{{ jobs.imdb_id }}</span></div>
                    <div class="detail-row"><span class="detail-label">IMDB ID (Auto)</span><span class="detail-value">{{ jobs.imdb_id_auto }}</span></div>
                    <div class="detail-row"><span class="detail-label">IMDB ID (Manual)</span><span class="detail-value">{{ jobs.imdb_id_manual }}</span></div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card detail-card h-100">
                <div class="card-header">Artwork & Sources</div>
                <div class="card-body p-0 poster-preview">
                    <div class="detail-row"><span class="detail-label">Poster URL</span>
                        <span class="detail-value">
                            <a href="{{ jobs.poster_url if jobs.poster_url else '#' }}">
                                <img src="{{ poster_src }}" alt="{{ poster_alt }}">
                            </a>
                            <span>{{ jobs.poster_url if jobs.poster_url else 'None' }}</span>
                        </span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Poster URL (Auto)</span>
                        <span class="detail-value">
                            <a href="{{ jobs.poster_url_auto if jobs.poster_url_auto else '#' }}">
                                <img src="{{ jobs.poster_url_auto if jobs.poster_url_auto else url_for('static', filename='img/none.png') }}" alt="Poster preview">
                            </a>
                            <span>{{ jobs.poster_url_auto if jobs.poster_url_auto else 'None' }}</span>
                        </span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Poster URL (Manual)</span>
                        <span class="detail-value">
                            <a href="{{ jobs.poster_url_manual if jobs.poster_url_manual else '#' }}">
                                <img src="{{ jobs.poster_url_manual if jobs.poster_url_manual else url_for('static', filename='img/none.png') }}" alt="Poster preview">
                            </a>
                            <span>{{ jobs.poster_url_manual if jobs.poster_url_manual else 'None' }}</span>
                        </span>
                    </div>
                    <div class="detail-row"><span class="detail-label">Label</span><span class="detail-value">{{ jobs.label }}</span></div>
                    <div class="detail-row"><span class="detail-label">Ejected</span><span class="detail-value">{{ jobs.ejected }}</span></div>
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card detail-card h-100">
                <div class="card-header">Paths & Configuration</div>
                <div class="card-body p-0">
                    <div class="detail-row"><span class="detail-label">Device Path</span><span class="detail-value">{{ jobs.devpath }}</span></div>
                    <div class="detail-row"><span class="detail-label">Mount Point</span><span class="detail-value">{{ jobs.mountpoint }}</span></div>
                    <div class="detail-row"><span class="detail-label">Destination Path</span><span class="detail-value">{{ jobs.path }}</span></div>
                    <div class="detail-row"><span class="detail-label">Config ID</span><span class="detail-value">{{ jobs.config.CONFIG_ID }}</span></div>
                    {% if jobs.video_type != "Music" %}
                        <div class="detail-row"><span class="detail-label">HB Preset (DVD)</span><span class="detail-value">{{ jobs.config.HB_PRESET_DVD }}</span></div>
                        <div class="detail-row"><span class="detail-label">HB Args (DVD)</span><span class="detail-value">{{ jobs.config.HB_ARGS_DVD }}</span></div>
                        <div class="detail-row"><span class="detail-label">HB Preset (BD)</span><span class="detail-value">{{ jobs.config.HB_PRESET_BD }}</span></div>
                        <div class="detail-row"><span class="detail-label">HB Args (BD)</span><span class="detail-value">{{ jobs.config.HB_ARGS_BD }}</span></div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-xl-4 col-md-6 mb-4">
            <div class="card detail-card h-100">
                <div class="card-header">Processing</div>
                <div class="card-body p-0">
                    <div class="detail-row"><span class="detail-label">Disc Type</span><span class="detail-value">{{ jobs.disctype }}</span></div>
                    <div class="detail-row"><span class="detail-label">PID</span><span class="detail-value">{{ jobs.pid }}</span></div>
                    <div class="detail-row"><span class="detail-label">PID Hash</span><span class="detail-value">{{ jobs.pid_hash }}</span></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="track-table-wrapper">
                <table id="tracktable" class="table table-striped table-hover" aria-label="Tracks">
                    <thead>
                    <tr>
                        <th scope="col" style="text-align:left">Track #</th>
                        {% if jobs.video_type == "Music" %}
                            <th scope="col" style="text-align:left">Track Name</th>
                        {% endif %}
                        <th scope="col" style="text-align:left">Length (sec)</th>
                        <th scope="col" style="text-align:left">FPS</th>
                        <th scope="col" style="text-align:left">Aspect Ratio</th>
                        <th scope="col" style="text-align:left">Main Feature</th>
                        <th scope="col" style="text-align:left">Ripped</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for track in tracks %}
                        <tr>
                            <td style="text-align:left"><strong>{{ track.track_number }}</strong></td>
                            {% if jobs.video_type == "Music" %}
                                <td style="text-align:left"><strong>{{ track.filename }}</strong></td>
                            {% endif %}
                            <td style="text-align:left">{{ track.length }} {{ " (Milliseconds)" if jobs.video_type == "Music" else "" }}</td>
                            <td style="text-align:left">{{ track.fps }}</td>
                            <td style="text-align:left">{{ track.aspect_ratio }}</td>
                            <td style="text-align:left">{{ track.main_feature }}</td>
                            <td style="text-align:left">{{ track.ripped }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<script type="application/javascript">
    $(function () {
        $("#plot").click(function () {
            $("#plotInfo").slideToggle(1000);
        });
        $("#posterClick").click(function () {
            $("#plotInfo").slideToggle(1000);
        });
    });
</script>
{% endblock %}
{% block footer %}{{ super() }}{% endblock %}
{% block js %}
    {{ super() }}
{% endblock %}
